# atom_agent.sandbox Documentation

## Overall Flow
`src/atom_agent/sandbox.py` provides a mechanism to execute Python code safely within an isolated environment using `bubblewrap` (bwrap). It is designed to prevent code from accessing sensitive parts of the host system, modifying configuration files, or making unauthorized network requests (although network isolation is explicitly noted as disabled due to WSL constraints).

The flow is:
1.  **Arguments**: Accepts a python script path, working directory (`attempt_dir`), arguments, and constraints (timeout, memory limit).
2.  **Validation**: Ensures paths exist and are within allowed bounds.
3.  **Command Construction**: Builds a complex `bwrap` command that:
    -   Unshares namespaces (user, pid, new session, etc.).
    -   Mounts system directories (`/usr`, `/bin`, `/lib`, etc.) as read-only.
    -   Mounts the working directory (`attempt_dir`) as `/work` (read-write).
    -   Sets up `/tmp` as a tmpfs.
    -   Clears environment variables and sets a minimal safe environment (`PATH`, `HOME`, `LANG`).
4.  **Execution**: Runs the constructed command using `subprocess.run` with `ulimit` restrictions.
5.  **Output Capture**: Captures `stdout` and `stderr`, truncating if they exceed limits.
6.  **Result**: Returns a `SandboxResult` object containing execution status and output.

## Use Cases
-   **Agent Code Execution**: Running code generated by the agent (e.g., `impl.py`, `test.py`) to verify functionality without risking the host system.
-   **Unit Testing**: Running test suites in a clean environment.

## Edge Cases
-   **Bubblewrap Missing**: If `bwrap` is not installed, execution will fail.
-   **Path Escapes**: Contains checks to ensure `script_path` is inside `attempt_dir`.
-   **Timeouts**: Handles `subprocess.TimeoutExpired` gracefully, returning a result with `timed_out=True`.
-   **Large Output**: Truncates output exceeding `stdout_limit_bytes` or `stderr_limit_bytes` to prevent memory issues.

## Method Documentation

### `SandboxResult` (Class)
A dictionary subclass representing the execution result.
-   **Fields**: `ok`, `exit_code`, `timed_out`, `stdout`, `stderr`, `cmd`.

### `_cap_output(data: bytes, limit_bytes: int) -> bytes`
Helper to truncate byte streams.
-   **Behavior**: If data size > limit, returns "...(truncated)..." + the last `limit_bytes` (tail).

### `run_in_bubblewrap(...)`
The main function to execute code in the sandbox.

-   **Arguments**:
    -   `attempt_dir` (Path): Host path to mount as `/work`.
    -   `script_path` (Path): Path to the python script to run (must be inside `attempt_dir`).
    -   `python_bin` (str): Python interpreter path (default: `/usr/bin/python3`).
    -   `args` (List[str]): Arguments for the script.
    -   `timeout_s` (int): Execution timeout in seconds.
    -   `stdout_limit_bytes`, `stderr_limit_bytes`: Output size limits.
    -   `extra_env` (Dict): Additional environment variables to set.
-   **Returns**: `SandboxResult`.
-   **Raises**: `FileNotFoundError`, `ValueError` (if paths are invalid).
-   **Key Logic**:
    -   Resolves paths.
    -   Constructs `bwrap` arguments for filesystem isolation.
    -   Constructs internal bash command with `ulimit` for resource control.
    -   Executes via `subprocess.run`.
